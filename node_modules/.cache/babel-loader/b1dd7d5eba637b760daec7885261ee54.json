{"ast":null,"code":"import React,{useCallback,useEffect,useMemo,useState}from'react';import Modal from'react-modal';import{useNavigate}from'react-router-dom';import{getApiUrl,getAuthHeaders}from'../../config';import{useAuth}from'../../context/AuthContext';import{useToast}from'../../context/ToastContext';import{FiEdit2,FiTrash2,FiPlus,FiSearch,FiBook,FiHash}from'react-icons/fi';import{SkeletonTable}from'../../components/SkeletonLoader';import EmptyState from'../../components/EmptyState';import StatusBadge from'../../components/StatusBadge';import Pagination from'../../components/Pagination';import SortableTableHeader from'../../components/SortableTableHeader';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function Students(){const navigate=useNavigate();const{token}=useAuth();const toast=useToast();const[query,setQuery]=useState('');const[klass,setKlass]=useState('');const[section,setSection]=useState('');const[students,setStudents]=useState([]);const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[deleteOpen,setDeleteOpen]=useState(false);const[deleteEmail,setDeleteEmail]=useState('');const[deleting,setDeleting]=useState(false);const[deleteError,setDeleteError]=useState('');const[currentPage,setCurrentPage]=useState(1);const itemsPerPage=6;const[sortConfig,setSortConfig]=useState({key:null,direction:'asc'});const fetchStudents=useCallback(async()=>{setLoading(true);setError('');try{const url=getApiUrl('/midland/admin/students/all');const res=await fetch(url,{headers:getAuthHeaders(token)});if(!res.ok){throw new Error(\"Failed to load students: \".concat(res.status,\" \").concat(res.statusText));}const data=await res.json();setStudents(Array.isArray(data)?data:[]);}catch(err){const errorMsg=err.message||'Failed to load students';if(err.message&&(err.message.includes('CORS')||err.message.includes('Failed to fetch')||err.message.includes('NetworkError'))){setError('CORS error: The backend at http://4.198.16.72.nip.io needs to allow requests from your frontend origin. Please configure CORS headers on the backend.');toast.error('Failed to load students. Please check your connection.');}else{setError(errorMsg);toast.error(errorMsg);}}finally{setLoading(false);}},[token,toast]);useEffect(()=>{fetchStudents();},[fetchStudents]);useEffect(()=>{const onKey=e=>{if(e.key==='Escape'&&deleteOpen&&!deleting){setDeleteOpen(false);setDeleteError('');}};window.addEventListener('keydown',onKey);return()=>window.removeEventListener('keydown',onKey);},[deleteOpen,deleting]);useEffect(()=>{try{Modal.setAppElement('#root');}catch(_){}},[]);const classes=useMemo(()=>{return Array.from(new Set(students.map(s=>String(s.gradeLevel||'').trim()).filter(Boolean)));},[students]);const sections=useMemo(()=>{return Array.from(new Set(students.map(s=>String(s.section||'').trim()).filter(Boolean)));},[students]);const handleSort=(key,direction)=>{setSortConfig({key,direction});setCurrentPage(1);};const sortedAndFilteredRows=useMemo(()=>{const q=query.trim().toLowerCase();let filtered=students.filter(s=>{const id=String(s.admissionNumber||s.rollNo||'').toLowerCase();const name=String(s.fullName||'').toLowerCase();const email=String(s.schoolEmail||s.personalEmail||'').toLowerCase();const queryMatch=!q||id.includes(q)||name.includes(q)||email.includes(q);const classMatch=!klass||String(s.gradeLevel||'')===klass;const sectionMatch=!section||String(s.section||'')===section;return queryMatch&&classMatch&&sectionMatch;}).map(s=>({key:s.admissionNumber||s.rollNo||s.studentUid||Math.random(),id:s.admissionNumber||s.rollNo||'-',name:s.fullName||'-',email:s.schoolEmail||s.personalEmail||'-',class:s.gradeLevel||'-',section:s.section||'-',status:s.status||'Active',emailKey:s.schoolEmail||s.personalEmail||''}));if(sortConfig.key){filtered.sort((a,b)=>{let aVal=a[sortConfig.key];let bVal=b[sortConfig.key];if(typeof aVal==='string'){aVal=aVal.toLowerCase();bVal=bVal.toLowerCase();}if(aVal<bVal)return sortConfig.direction==='asc'?-1:1;if(aVal>bVal)return sortConfig.direction==='asc'?1:-1;return 0;});}return filtered;},[students,query,klass,section,sortConfig]);const totalPages=Math.ceil(sortedAndFilteredRows.length/itemsPerPage);const startIndex=(currentPage-1)*itemsPerPage;const endIndex=startIndex+itemsPerPage;const rows=sortedAndFilteredRows.slice(startIndex,endIndex);useEffect(()=>{if(currentPage>totalPages&&totalPages>0){setCurrentPage(1);}},[totalPages,currentPage]);return/*#__PURE__*/_jsxs(\"div\",{className:\"page students\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"page-header\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"header-main\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Students\"}),/*#__PURE__*/_jsx(\"div\",{className:\"meta\",children:loading?'Loading…':\"\".concat(sortedAndFilteredRows.length,\" student\").concat(sortedAndFilteredRows.length!==1?'s':'')})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"btn-primary\",onClick:()=>navigate('/students/create'),children:[/*#__PURE__*/_jsx(FiPlus,{size:18,style:{marginRight:8}}),\"Add Student\"]})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"alert alert-error\",children:error}),/*#__PURE__*/_jsxs(\"div\",{className:\"filters\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"filter-input-wrapper\",children:[/*#__PURE__*/_jsx(FiSearch,{className:\"filter-icon\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",placeholder:\"Search by ID, name, or email...\",value:query,onChange:e=>setQuery(e.target.value),className:\"filter-input\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-select-wrapper\",children:[/*#__PURE__*/_jsx(FiBook,{className:\"filter-icon\"}),/*#__PURE__*/_jsxs(\"select\",{value:klass,onChange:e=>setKlass(e.target.value),className:\"filter-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"All Classes\"}),classes.map(c=>/*#__PURE__*/_jsx(\"option\",{value:c,children:c},c))]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"filter-select-wrapper\",children:[/*#__PURE__*/_jsx(FiHash,{className:\"filter-icon\"}),/*#__PURE__*/_jsxs(\"select\",{value:section,onChange:e=>setSection(e.target.value),className:\"filter-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"All Sections\"}),sections.map(s=>/*#__PURE__*/_jsx(\"option\",{value:s,children:s},s))]})]})]}),loading?/*#__PURE__*/_jsx(SkeletonTable,{rows:5,columns:7}):sortedAndFilteredRows.length===0?/*#__PURE__*/_jsx(EmptyState,{type:\"students\",actionLabel:\"Add Student\",onAction:()=>navigate('/students/create')}):/*#__PURE__*/_jsx(\"div\",{className:\"table-container\",children:/*#__PURE__*/_jsxs(\"table\",{className:\"data-table\",children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"id\",currentSort:sortConfig,onSort:handleSort,children:\"ID\"}),/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"name\",currentSort:sortConfig,onSort:handleSort,children:\"Name\"}),/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"email\",currentSort:sortConfig,onSort:handleSort,children:\"Email\"}),/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"class\",currentSort:sortConfig,onSort:handleSort,children:\"Class\"}),/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"section\",currentSort:sortConfig,onSort:handleSort,children:\"Section\"}),/*#__PURE__*/_jsx(SortableTableHeader,{sortKey:\"status\",currentSort:sortConfig,onSort:handleSort,children:\"Status\"}),/*#__PURE__*/_jsx(SortableTableHeader,{className:\"actions-column\",children:\"Actions\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:rows.map(row=>/*#__PURE__*/_jsxs(\"tr\",{children:[/*#__PURE__*/_jsx(\"td\",{className:\"cell-id\",children:row.id}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-name\",children:/*#__PURE__*/_jsx(\"button\",{className:\"name-link\",onClick:()=>navigate(\"/students/\".concat(row.emailKey||row.id)),title:\"View Profile\",children:row.name})}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-email\",children:row.email}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-small\",children:row.class}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-small\",children:row.section}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-status\",children:/*#__PURE__*/_jsx(StatusBadge,{status:row.status})}),/*#__PURE__*/_jsx(\"td\",{className:\"cell-actions\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"action-buttons\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn-icon\",onClick:()=>navigate(\"/students/\".concat(row.emailKey||row.id,\"/edit\")),title:\"Edit\",\"aria-label\":\"Edit student\",children:/*#__PURE__*/_jsx(FiEdit2,{size:18})}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-icon btn-danger\",onClick:()=>{setDeleteEmail(row.emailKey);setDeleteOpen(true);},title:\"Delete\",\"aria-label\":\"Delete student\",children:/*#__PURE__*/_jsx(FiTrash2,{size:18})})]})})]},row.key))})]})}),!loading&&sortedAndFilteredRows.length>0&&/*#__PURE__*/_jsx(Pagination,{currentPage:currentPage,totalPages:totalPages,onPageChange:setCurrentPage}),/*#__PURE__*/_jsx(Modal,{isOpen:deleteOpen,onRequestClose:()=>!deleting&&setDeleteOpen(false),className:\"modal\",overlayClassName:\"modal-overlay\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-content\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Delete Student\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Are you sure you want to delete this student? This action cannot be undone.\"}),deleteError&&/*#__PURE__*/_jsx(\"div\",{className:\"alert alert-error\",style:{marginBottom:16},children:deleteError}),/*#__PURE__*/_jsxs(\"div\",{className:\"modal-actions\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn-secondary\",onClick:()=>setDeleteOpen(false),disabled:deleting,children:\"Cancel\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn-danger\",disabled:deleting,onClick:async()=>{if(!deleteEmail)return;setDeleting(true);setDeleteError('');try{const emailKey=encodeURIComponent(deleteEmail);const url=getApiUrl(\"/midland/admin/students/delete/\".concat(emailKey));const res=await fetch(url,{method:'DELETE',headers:getAuthHeaders(token)});if(!res.ok){const errorText=await res.text().catch(()=>'');throw new Error(errorText||\"Failed to delete: \".concat(res.status));}setDeleteOpen(false);toast.success('Student deleted successfully');fetchStudents();}catch(err){const errorMsg=err.message||'Failed to delete student';setDeleteError(errorMsg);toast.error(errorMsg);}finally{setDeleting(false);}},children:deleting?'Deleting…':'Delete'})]})]})})]});}","map":null,"metadata":{},"sourceType":"module"}